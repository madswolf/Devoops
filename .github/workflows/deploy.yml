name: Build & Deploy
on: 
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Deploy shittytwitter app
      uses: appleboy/ssh-action@v0.1.4
      with:
        host: ${{secrets.SSH_HOST}}
        key: ${{secrets.ACTIONS_SSH_KEY_PRIVATE}}
        username: ${{secrets.SSH_HOST_USERNAME}}
        script: |
          . env.sh
          rm -rf devoops
          mkdir devoops
          cd devoops
          echo $DATABASE_CONNECTION_STRING > test1
          echo $DIGITAL_OCEAN_TOKEN > test2
          echo $DROPLET_PROD_NAME > test3
          echo $DROPLET_TEMP_NAME > test4
          echo $SSH_KEY_NAME > test5
          echo $SSH_KEY_PRIVATE > test6
          echo $SSH_KEY_PUBLIC > test7
          git clone https://github.com/ChadIImus/Devoops.git
          echo copying keys
          cp ~/$SSH_KEY_NAME".pub" Devoops/aspnet/
          cp ~/$SSH_KEY_NAME Devoops/aspnet/
          cp ~/$SSH_KEY_NAME".pub" Devoops/scripts/deployscripts/
          cp ~/$SSH_KEY_NAME Devoops/scripts/deployscripts/
          cd Devoops/aspnet/
          echo making new vm environment file
          echo export DATABASE_CONNECTION_STRING=\"$DATABASE_CONNECTION_STRING\">env.sh
          echo deploying droplet
          export DROPLET_NAME=$DROPLET_TEMP_NAME
          vagrant up
          now=$(date +"%T")
          echo "Current time : $now"
          cd ../scripts/deployscripts/
          chmod +x ReplaceAndDestroyProdIfAlive.sh
          echo Replacing prod if staging droplet is alive
          ./ReplaceAndDestroyProdIfAlive.sh $DROPLET_TEMP_NAME $DIGITAL_OCEAN_TOKEN $DROPLET_PROD_NAME